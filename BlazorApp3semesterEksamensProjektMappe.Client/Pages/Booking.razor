@page "/booking"
@using BlazorApp3semesterEksamensProjektMappe.shared.Models
@using BlazorApp3semesterEksamensProjektMappe.Client.Services
@inject IHutService HutService
@inject IProductService ProductService
@inject IBookingService BookingService
@rendermode InteractiveServer

<h3>Opret Booking</h3>

<EditForm Model="_dto" OnValidSubmit="HandleBooking" FormName="BookingForm">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div>
        <label>Startdato:</label>
        <InputDate @bind-Value="_dto.StartDate" />
    </div>

    <div>
        <label>Slutdato:</label>
        <InputDate @bind-Value="_dto.EndDate" />
    </div>

    <div>
        <label>Produkt:</label>
        <InputSelect TValue="int" @bind-Value="_dto.ProductId">
            <option value="0">-- vælg produkt --</option>
            @foreach (var p in _products)
            {
                <option value="@p.Id">@p.ProductType (@p.SeasonalPrice kr./nat + @p.ServicePrice kr. service)</option>
            }
        </InputSelect>
    </div>

    <div>
        <label>Hytte:</label>
        <InputSelect TValue="int" @bind-Value="_dto.UserId">
            <option value="0">-- vælg hytte --</option>
            @foreach (var h in _huts)
            {
                <option value="@h.Id">Hytte #@h.Id (Kapacitet: @h.MaxCapacity)</option>
            }
        </InputSelect>
    </div>

    <button type="submit">Book</button>
</EditForm>

<p>Valgt produktId: @_dto.ProductId</p>
<p>Valgt userId (hytte): @_dto.UserId</p>

@if (!string.IsNullOrEmpty(_error))
{
    <p style="color:red">@_error</p>
}

@if (_created is not null)
{
    <p style="color:green">
        Booking #@_created.Id — Produkt: @_created.Product?.ProductType — Periode: @_created.StartDate.ToShortDateString() til @_created.EndDate.ToShortDateString()
    </p>
}

@code {
    private BookingDto _dto = new()
    {
        StartDate = DateTime.Today,
        EndDate = DateTime.Today.AddDays(1),
        ProductId = 0,
        UserId = 0
    };

    private BookingDto? _created;
    private List<ProductDto> _products = new();
    private List<HutDto> _huts = new();
    private string _error = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        _products = await ProductService.GetAllAsync();
        _huts = await HutService.GetAllAsync();

        if (_dto.ProductId == 0 && _products.Any())
            _dto.ProductId = _products.First().Id;

        if (_dto.UserId == 0 && _huts.Any())
            _dto.UserId = _huts.First().Id;
    }

    private async Task HandleBooking()
    {
        _error = string.Empty;

        if (_dto.ProductId == 0 || _dto.UserId == 0)
        {
            _error = "Du skal vælge både produkt og hytte.";
            return;
        }

        _created = await BookingService.CreateAsync(_dto);
        StateHasChanged();
    }
}