@page "/booking"
@using Danplanner.Shared.Models
@using Danplanner.Client.Services
@inject IResourceService ResourceService
@inject IProductService ProductService
@inject IBookingService BookingService
@rendermode InteractiveServer

<h3>Opret Booking</h3>

<EditForm Model="_dto" OnValidSubmit="HandleBooking" FormName="BookingForm">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div>
        <label>Startdato:</label>
        <InputDate @bind-Value="_dto.StartDate" />
    </div>

    <div>
        <label>Slutdato:</label>
        <InputDate @bind-Value="_dto.EndDate" />
    </div>

    <div>
        <label>Produkt:</label>
        <InputSelect TValue="int" @bind-Value="_dto.ProductId">
            <option value="0">-- vælg produkt --</option>
            @foreach (var p in _products)
            {
                <option value="@p.Id">@p.Name (@p.BasePrice kr./nat)</option>
            }
        </InputSelect>
    </div>

    <div>
        <label>Ressource:</label>
        <InputSelect TValue="int" @bind-Value="_dto.ResourceId">
            <option value="0">-- vælg ressource --</option>
            @foreach (var r in _resources)
            {
                <option value="@r.Id">@r.Name (@r.Type)</option>
            }
        </InputSelect>
    </div>

    <button type="submit">Book</button>
</EditForm>

<p>Valgt produktId: @_dto.ProductId</p>
<p>Valgt resourceId: @_dto.ResourceId</p>

@if (!string.IsNullOrEmpty(_error))
{
    <p style="color:red">@_error</p>
}

@if (_created is not null)
{
    <p style="color:green">
        Booking #@_created.Id — @_created.ResourceName / @_created.ProductName —
        Total: @_created.TotalPrice kr.
    </p>
}

@code {
    private BookingDto _dto = new()
    {
        StartDate = DateTime.Today,
        EndDate = DateTime.Today.AddDays(1),
        ProductId = 0,
        ResourceId = 0
    };

    private BookingDto? _created;
    private List<ProductDto> _products = new();
    private List<ResourceDto> _resources = new();
    private string _error = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        _products = await ProductService.GetAllAsync();
        _resources = await ResourceService.GetAllAsync();

        // Sæt kun defaults hvis værdien er 0
        if (_dto.ProductId == 0 && _products.Any())
            _dto.ProductId = _products.First().Id;

        if (_dto.ResourceId == 0 && _resources.Any())
            _dto.ResourceId = _resources.First().Id;
    }

    private async Task HandleBooking()
    {
        _error = string.Empty;

        Console.WriteLine($"[Booking] ProductId={_dto.ProductId}, ResourceId={_dto.ResourceId}");

        if (_dto.ProductId == 0 || _dto.ResourceId == 0)
        {
            _error = "Du skal vælge både produkt og ressource.";
            return;
        }

        _created = await BookingService.CreateAsync(_dto);
        StateHasChanged();
    }
}