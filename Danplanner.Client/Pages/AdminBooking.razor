@page "/admin-booking"
@rendermode InteractiveServer
@using Danplanner.Shared.Models
@using Danplanner.Client.Services
@using System.Security.Cryptography
@inject ICottageService CottageService
@inject IGrassFieldService GrassFieldService
@inject IProductService ProductService
@inject IBookingService BookingService
@inject IAddonService AddonService
@inject Authservice AuthService
@inject IBookingPriceService BookingPriceService
@inject IBookingValidationService BookingValidationService
@inject IJSRuntime JS

<h3>Admin Booking</h3>

@if (AuthService.CurrentUser?.Role != "Admin")
{
    <div class="alert alert-warning">
        Du har ikke adgang til denne side.
    </div>
}
else
{
    <div class="row">
        <!-- VENSTRE: trinvist flow (stacked cards) -->
        <div class="col-lg-8">
            <!-- TRIN 0: Booking detaljer -->
            <div id="step-booking" class="card mb-4 @(CurrentStep == 0 ? "border-primary shadow-sm" : "border-light")">
                <div class="card-body">
                    <h5 class="card-title">1 — Booking detaljer</h5>

                    <EditForm Model="_dto" OnValidSubmit="HandleBooking">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label small">Startdato</label>
                                <InputDate class="form-control" @bind-Value="StartDateProp" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small">Slutdato</label>
                                <InputDate class="form-control" @bind-Value="EndDateProp" />
                                @if (!string.IsNullOrEmpty(_dateError))
                                {
                                    <div class="text-danger small mt-1">@_dateError</div>
                                }
                            </div>

                            <div class="col-12">
                                <label class="form-label small">Produkt</label>
                                <InputSelect class="form-select" TValue="int" @bind-Value="ProductId">
                                    <option value="0">-- vælg produkt --</option>
                                    @foreach (var p in _products)
                                    {
                                        <option value="@p.Id">@TranslateType(p.ProductType) (@p.Id)</option>
                                    }
                                </InputSelect>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label small">Antal personer</label>
                                <InputNumber class="form-control" @bind-Value="NumberOfPeopleProp" />
                                @if (!string.IsNullOrEmpty(_personError))
                                {
                                    <div class="text-danger small mt-1">@_personError</div>
                                }
                            </div>

                            @if (_selectedProduct?.ProductType == ProductType.Cottage)
                            {
                                <div class="col-md-8">
                                    <label class="form-label small">Hytte</label>
                                    <InputSelect class="form-select" TValue="int?" @bind-Value="CottageIdProp">
                                        <option value="@((int?)null)">-- vælg hytte --</option>
                                        @foreach (var h in _cottages.Where(h => h.ProductId == _selectedProduct.Id))
                                        {
                                            <option value="@h.Id">Hytte #@h.Number (kap: @h.MaxCapacity) — @h.PricePerNight.ToString("0.00") kr./nat</option>
                                        }
                                    </InputSelect>
                                </div>
                            }
                            else if (_selectedProduct?.ProductType == ProductType.GrassField)
                            {
                                <div class="col-12">
                                    <label class="form-label small">Græsplads</label>
                                    <InputSelect class="form-select" TValue="int?" @bind-Value="GrassFieldIdProp">
                                        <option value="@((int?)null)">-- vælg græsplads --</option>
                                        @foreach (var g in _grassFields.Where(g => g.ProductId == _selectedProduct.Id))
                                        {
                                            <option value="@g.Id">Plads #@g.Number (Størrelse: @g.Size) — @g.PricePerNight.ToString("0.00") kr./nat</option>
                                        }
                                    </InputSelect>
                                </div>
                            }

                            @if (_addons.Any())
                            {
                                <div class="col-12">
                                    <label class="form-label small">Tilkøb</label>
                                    <div class="border rounded p-2">
                                        @foreach (var a in _addons)
                                        {
                                            <div class="d-flex align-items-center mb-2">
                                                <input class="form-check-input me-2" type="checkbox"
                                                       checked="@_selectedAddonIds.Contains(a.Id)"
                                                       @onchange="@((ChangeEventArgs e) => ToggleAddon(a.Id, e))" />
                                                <div class="flex-grow-1">
                                                    <strong>@a.Name</strong> — @a.Price.ToString("0.00") kr.
                                                </div>
                                                <div style="width:110px">
                                                    <input class="form-control form-control-sm" type="number" min="1"
                                                           value="@GetQuantity(a.Id)"
                                                           @onchange="@((ChangeEventArgs e) => SetQuantity(a.Id, int.Parse(e.Value?.ToString() ?? "1")))" />
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }

                            <div class="col-12">
                                <div class="d-flex justify-content-end gap-2 mt-3">
                                    <button type="submit"
                                            class="btn btn-outline-primary"
                                            disabled="@(!CanProceedFromStep0)">
                                        Gå videre — Kundeinfo
                                    </button>
                                </div>
                            </div>
                        </div>
                    </EditForm>
                </div>
            </div>

            <!-- TRIN 1: Kundeoplysninger -->
            <div id="step-user" class="card mb-4 @(CurrentStep == 1 ? "border-primary shadow-sm" : "border-light")">
                <div class="card-body">
                    <h5 class="card-title">2 — Kundeoplysninger</h5>

                    <EditForm Model="_user" OnValidSubmit="GoToSummary">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        <div class="row g-3">
                            <!-- VÆLG EKSISTERENDE KUNDE -->
                            <div class="col-12">
                                <label class="form-label small">Eksisterende kunde</label>
                                <InputSelect class="form-select" TValue="int?" @bind-Value="SelectedUserId">
                                    <option value="@((int?)null)">-- vælg eksisterende kunde eller indtast ny nedenfor --</option>
                                    @foreach (var u in _users)
                                    {
                                        <option value="@u.Id">@u.Name (@u.Email)</option>
                                    }
                                </InputSelect>
                            </div>

                            <!-- FELTER TIL NY / REDIGERET KUNDE -->
                            <div class="col-md-6">
                                <label class="form-label small">Navn</label>
                                <InputText class="form-control" @bind-Value="_user.Name" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small">Email</label>
                                <InputText class="form-control" @bind-Value="_user.Email" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small">Telefon</label>
                                <InputText class="form-control" @bind-Value="_user.Phone" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small">Land</label>
                                <InputText class="form-control" @bind-Value="_user.Country" />
                            </div>
                            <div class="col-md-8">
                                <label class="form-label small">Adresse</label>
                                <InputText class="form-control" @bind-Value="_user.Address" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small">Sprog</label>
                                <InputText class="form-control" @bind-Value="_user.Language" />
                            </div>


                            <div class="col-12 d-flex justify-content-end mt-3">
                                <button type="submit" class="btn btn-outline-primary">Gå videre — Opsummering</button>
                            </div>
                        </div>
                    </EditForm>

                    <div class="mt-2">
                        <button class="btn btn-link" @onclick="() => GoBackToStep(0)">Rediger booking oplysninger</button>
                    </div>
                </div>
            </div>

            <!-- TRIN 2: Opsummering & bekræft -->
            <div id="step-summary" class="card mb-4 @(CurrentStep == 2 ? "border-primary shadow-sm" : "border-light")">
                <div class="card-body">
                    <h5 class="card-title">3 — Opsummering</h5>

                    <div class="mb-3">
                        <ul class="list-unstyled">
                            <li><strong>Periode:</strong> @_dto.StartDate.ToShortDateString() – @_dto.EndDate.ToShortDateString()</li>
                            <li><strong>Produkt:</strong> @_selectedProduct?.ProductType</li>
                            <li><strong>Antal personer:</strong> @_dto.NumberOfPeople</li>
                            @if (_dto.CottageId != null)
                            {
                                <li><strong>Hytte:</strong> @_cottages.FirstOrDefault(c => c.Id == _dto.CottageId)?.Number</li>
                            }
                            @if (_dto.GrassFieldId != null)
                            {
                                <li><strong>Græsplads:</strong> @_grassFields.FirstOrDefault(g => g.Id == _dto.GrassFieldId)?.Number</li>
                            }
                            @if (_selectedAddonIds.Any())
                            {
                                <li>
                                    <strong>Tilkøb:</strong>
                                    <ul>
                                        @foreach (var id in _selectedAddonIds)
                                        {
                                            var addon = _addons.FirstOrDefault(a => a.Id == id);
                                            <li>@addon?.Name x @GetQuantity(id) — @addon?.Price.ToString("0.00") kr.</li>
                                        }
                                    </ul>
                                </li>
                            }
                            <li><strong>Kunde:</strong> @_user.Name (@_user.Email)</li>
                            <li><strong>Totalpris:</strong> @TotalPrice.ToString("0.00") kr.</li>
                        </ul>
                    </div>

                    <div class="d-flex justify-content-between">
                        <div>
                            <button class="btn btn-link" @onclick="() => GoBackToStep(1)">Rediger kundeinfo</button>
                            <button class="btn btn-link" @onclick="() => GoBackToStep(0)">Rediger booking</button>
                        </div>
                        <div>
                            <button class="btn btn-success" @onclick="ConfirmBooking" disabled="@(!CanConfirm)">
                                Bekræft booking
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TRIN 3: Bekræftet -->
            <div id="step-confirmation" class="card mb-4 @(CurrentStep == 3 ? "border-success shadow-sm" : "border-light")">
                <div class="card-body">
                    <h5 class="card-title">4 — Bekræftet</h5>

                    @if (_created != null)
                    {
                        <p class="text-success">
                            Booking <strong>#@_created.Id</strong> er bekræftet og aktiv.
                        </p>
                        <p>En bekræftelsesmail er sendt til: <strong>@_user.Email</strong></p>
                    }
                    else if (_hasAttemptedCreate)
                    {
                        <p class="text-success">Afvent venligst mens vi bekræfter din booking...</p>
                    }

                    <div class="mt-3">
                        <button class="btn btn-outline-primary" @onclick="StartNewBooking">
                            Opret ny booking
                        </button>
                    </div>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(_error))
            {
                <div class="alert alert-danger">@_error</div>
            }
            @if (!string.IsNullOrEmpty(_debugMessage))
            {
                <div class="alert alert-info">@_debugMessage</div>
            }
        </div>

        <!-- HØJRE: opsummering / detaljer (sticky) -->
        <div class="col-lg-4">
            <div class="card sticky-top" style="top:20px">
                <div class="card-body">
                    <h6 class="card-title">Din booking (live)</h6>
                    <ul class="list-unstyled small">
                        <li><strong>Periode:</strong> @_dto.StartDate.ToShortDateString() – @_dto.EndDate.ToShortDateString()</li>
                        <li><strong>Produkt:</strong> @_selectedProduct?.ProductType</li>
                        <li><strong>Antal personer:</strong> @_dto.NumberOfPeople</li>
                        @if (_dto.CottageId != null)
                        {
                            <li><strong>Hytte:</strong> @_cottages.FirstOrDefault(c => c.Id == _dto.CottageId)?.Number</li>
                        }
                        @if (_dto.GrassFieldId != null)
                        {
                            <li><strong>Græsplads:</strong> @_grassFields.FirstOrDefault(g => g.Id == _dto.GrassFieldId)?.Number</li>
                        }
                        @if (_selectedAddonIds.Any())
                        {
                            <li>
                                <strong>Tilkøb:</strong>
                                <ul class="mb-0">
                                    @foreach (var id in _selectedAddonIds)
                                    {
                                        var addon = _addons.FirstOrDefault(a => a.Id == id);
                                        <li>@addon?.Name x @GetQuantity(id) — @addon?.Price.ToString("0.00") kr.</li>
                                    }
                                </ul>
                            </li>
                        }
                        <li class="mt-2"><strong>Kunde:</strong> @_user.Name (@_user.Email)</li>
                        <li class="mt-2"><strong>Total:</strong> @TotalPrice.ToString("0.00") kr.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
}

@code {

    // ---------------------------------------------
    // Felt- og tilstands-variabler til wizard-flowet
    // ---------------------------------------------

    // Om vi har forsøgt at oprette/bekræfte en booking (bruges til besked i trin 4)
    private bool _hasAttemptedCreate = false;

    // Holder styr på hvilket trin i wizzard-flowet vi er på (0–3)
    private int CurrentStep = 0;

    // Booking-DTO der binder til formularen i trin 0
    private BookingDto _dto = new()
    {
        StartDate = DateTime.Today,
        EndDate = DateTime.Today.AddDays(1),
        ProductId = 0,
        NumberOfPeople = 1,
        BookingAddons = new List<BookingAddonDto>()
    };

    // Booking som lige er blevet oprettet/bekræftet
    private BookingDto? _created;

    // Data caches til produkter, hytter, græspladser og tilkøb (hentes i OnInitializedAsync)
    private List<ProductDto> _products = new();
    private List<CottageDto> _cottages = new();
    private List<GrassFieldDto> _grassFields = new();
    private List<AddonDto> _addons = new();

    // Allerede eksisterende bookinger bruges til at tjekke overlap i datoer
    private List<BookingDto> _existingBookings = new();

    // Alle brugere (kundenavn + email) hentet fra Auth-API'et (kun for Admin)
    private List<UserDto> _users = new();

    // Hvilke tilkøb (addons) der er valgt i UI'et
    private HashSet<int> _selectedAddonIds = new();

    // Antal stk. per tilkøb (Id → quantity)
    private Dictionary<int, int> _addonQuantities = new();

    // Det produkt (hytte/græsplads) der aktuelt er valgt
    private ProductDto? _selectedProduct;

    // Fejlbeskeder til UI
    private string _error = "";
    private string _personError = "";
    private string _dateError = "";

    // Kundeoplysninger (navn, email, adresse, osv.)
    private AuthRequest _user = new();

    // Det Id som bruges ved ConfirmAsync (enten eksisterende bruger eller nyoprettet)
    private int _userId;

    // Debug / status tekst der vises til Admin (f.eks. "Booking oprettet med ID...")
    private string _debugMessage = "";

    // Beregnet totalpris for bookingen
    private decimal TotalPrice = 0;



    // Id for den valgte eksisterende bruger (fra dropdown)
    private int? _selectedUserId;

    // Property til binding af valgt bruger i UI (kører prefill af felter)
    private int? SelectedUserId
    {
        get => _selectedUserId;
        set
        {
            _selectedUserId = value;

            if (value.HasValue)
            {
                // Hvis admin vælger en eksisterende bruger,
                // så pre-filler vi felterne med brugerens data
                var u = _users.FirstOrDefault(x => x.Id == value.Value);
                if (u != null)
                {
                    _user.Name = u.Name;
                    _user.Email = u.Email;
                    _user.Address = u.Address;
                    _user.Phone = u.Phone;
                    _user.Country = u.Country;
                    _user.Language = u.Language;
                }
            }
            else
            {
                // Hvis dropdown sættes tilbage til "ingen valgt", så starter vi forfra med ny kunde
                _user = new AuthRequest();
            }
        }
    }

    // Kan man gå videre fra trin 0 til trin 1?
    // Kræver valgt produkt + ingen person- eller dato-fejl
    private bool CanProceedFromStep0 =>
        _dto.ProductId > 0 &&
        string.IsNullOrEmpty(_personError) &&
        string.IsNullOrEmpty(_dateError);

    // Kan man bekræfte bookingen (trin 2 → 3)?
    private bool CanConfirm =>
        string.IsNullOrEmpty(_personError) &&
        string.IsNullOrEmpty(_dateError);

    // ---------------------------------------------
    // Wrapper properties der reagerer på UI-ændringer
    // ---------------------------------------------

    // Når produkt ændres i UI → opdater DTO, nulstil hytte/plads, genberegn pris og valider
    private int ProductId
    {
        get => _dto.ProductId;
        set
        {
            _dto.ProductId = value;
            _selectedProduct = _products.FirstOrDefault(p => p.Id == value);
            _dto.CottageId = null;
            _dto.GrassFieldId = null;
            UpdateTotal();
            ValidateNumberOfPeople();
            ValidateAvailability();
        }
    }

    // Når hytte ændres → opdater DTO og re-valider/omregn
    private int? CottageIdProp
    {
        get => _dto.CottageId;
        set
        {
            _dto.CottageId = value;
            UpdateTotal();
            ValidateNumberOfPeople();
            ValidateAvailability();
        }
    }

    // Når græsplads ændres → opdater DTO og re-valider/omregn
    private int? GrassFieldIdProp
    {
        get => _dto.GrassFieldId;
        set
        {
            _dto.GrassFieldId = value;
            UpdateTotal();
            ValidateNumberOfPeople();
            ValidateAvailability();
        }
    }

    // Når startdato ændres → gem, beregn pris og tjek overlap
    private DateTime StartDateProp
    {
        get => _dto.StartDate;
        set
        {
            _dto.StartDate = value;
            UpdateTotal();
            ValidateAvailability();
        }
    }

    // Når slutdato ændres → gem, beregn pris og tjek overlap
    private DateTime EndDateProp
    {
        get => _dto.EndDate;
        set
        {
            _dto.EndDate = value;
            UpdateTotal();
            ValidateAvailability();
        }
    }

    // Når antal personer ændres → opdater DTO, tjek max-kapacitet og genberegn pris
    private int NumberOfPeopleProp
    {
        get => _dto.NumberOfPeople;
        set
        {
            _dto.NumberOfPeople = value;
            ValidateNumberOfPeople();
            UpdateTotal();
        }
    }

    // Kalder domain-service til max-kapacitet validering 
    private void ValidateNumberOfPeople()
    {
        _personError = BookingValidationService.ValidateNumberOfPeople(
            _dto,
            _selectedProduct,
            _cottages,
            _grassFields
        );
    }

    // Kalder domain-service til overlappende datoer (tilgængelighed)
    private void ValidateAvailability()
    {
        _dateError = BookingValidationService.ValidateAvailability(
            _dto,
            _selectedProduct,
            _existingBookings
        );

        StateHasChanged();
    }

    // ---------------------------------------------
    // Lifecycle: henter data ved første load
    // ---------------------------------------------
    protected override async Task OnInitializedAsync()
    {
        // Simpelt adgangstjek på UI-siden (sikkerhed håndteres stadig på server/API)
        if (AuthService.CurrentUser?.Role != "Admin")
            throw new InvalidOperationException("Bad request");

        // Hent domænedata til dropdowns og validering
        _products = await ProductService.GetAllAsync();
        _cottages = await CottageService.GetAllAsync();
        _grassFields = await GrassFieldService.GetAllAsync();
        _addons = await AddonService.GetAllAsync();
        _existingBookings = await BookingService.GetAllAsync();

        // Hent eksisterende brugere fra auth-service, så admin kan vælge dem i dropdown
        _users = await AuthService.GetUsersAsync();

        // Standard quantity = 1 for alle tilkøb
        foreach (var addon in _addons)
            _addonQuantities[addon.Id] = 1;

        UpdateTotal();
    }

    // ---------------------------------------------
    // Prisberegning (bruger dedikeret service)
    // ---------------------------------------------
    private void UpdateTotal()
    {
        TotalPrice = BookingPriceService.CalculatePreviewTotal(
            _dto,
            _selectedProduct,
            _cottages,
            _grassFields,
            _addons,
            _addonQuantities,
            _selectedAddonIds
        );

        _dto.TotalPrice = TotalPrice;
        StateHasChanged();
    }

    // ---------------------------------------------
    // Trin 0 → håndtering af booking-detaljer
    // ---------------------------------------------
    private async Task HandleBooking()
    {
        _error = "";

        if (_dto.ProductId <= 0)
        {
            _error = "Vælg venligst et produkt.";
            return;
        }

        if (_selectedProduct?.ProductType == ProductType.Cottage && _dto.CottageId == null)
        {
            _error = "Vælg venligst en hytte for det valgte produkt.";
            return;
        }

        if (_selectedProduct?.ProductType == ProductType.GrassField && _dto.GrassFieldId == null)
        {
            _error = "Vælg venligst en græsplads for det valgte produkt.";
            return;
        }

        if (_dto.StartDate > _dto.EndDate)
        {
            _error = "Startdato skal være før slutdato.";
            return;
        }

        if (!string.IsNullOrEmpty(_personError))
        {
            _error = "Antal personer overskrider maksimum for valgt produkt.";
            return;
        }

        if (!string.IsNullOrEmpty(_dateError))
        {
            _error = "Den valgte periode er ikke ledig for det valgte produkt.";
            return;
        }

        // Kopier valgte tilkøb over i DTO'en inden vi går videre i flowet
        _dto.BookingAddons = _selectedAddonIds
            .Select(id => new BookingAddonDto { AddonId = id, Quantity = GetQuantity(id) })
            .ToList();

        _dto.Status = "Afventer";
        CurrentStep = 1;
        await ScrollToSection("step-user");
    }

    // ---------------------------------------------
    // Trin 1 → kundeoplysninger valideret
    // ---------------------------------------------
    private async Task GoToSummary()
    {
        _error = "";
        if (string.IsNullOrWhiteSpace(_user.Name) || string.IsNullOrWhiteSpace(_user.Email))
        {
            _error = "Navn og email er påkrævet.";
            return;
        }

        CurrentStep = 2;
        await ScrollToSection("step-summary");
    }

    // ---------------------------------------------
    // Trin 2 → bekræft booking + opret/bruger kunde
    // ---------------------------------------------
    private async Task ConfirmBooking()
    {
        _error = "";
        _debugMessage = "";
        _hasAttemptedCreate = true;

        // Ekstra defensiv validering inden vi kalder serveren
        if (_dto.ProductId <= 0)
        {
            _error = "Produkt mangler.";
            await ScrollToSection("step-booking");
            return;
        }

        if (_selectedProduct?.ProductType == ProductType.Cottage && _dto.CottageId == null)
        {
            _error = "Hytte mangler.";
            await ScrollToSection("step-booking");
            return;
        }

        if (_selectedProduct?.ProductType == ProductType.GrassField && _dto.GrassFieldId == null)
        {
            _error = "Græsplads mangler.";
            await ScrollToSection("step-booking");
            return;
        }

        if (!string.IsNullOrEmpty(_personError))
        {
            _error = "Antal personer overskrider maksimum for valgt produkt.";
            await ScrollToSection("step-booking");
            return;
        }

        if (!string.IsNullOrEmpty(_dateError))
        {
            _error = "Den valgte periode er ikke ledig for det valgte produkt.";
            await ScrollToSection("step-booking");
            return;
        }

        _dto.BookingAddons = _selectedAddonIds
            .Select(id => new BookingAddonDto { AddonId = id, Quantity = GetQuantity(id) })
            .ToList();

        _dto.Status = "Afventer";

        try
        {
            // 1) Opret booking på Danplanner-API'et
            var created = await BookingService.CreateAsync(_dto);
            if (created is null)
            {
                _error = "Booking kunne ikke oprettes på serveren.";
                return;
            }

            _created = created;
            _debugMessage = $"Booking oprettet med ID {_created.Id}.";

            // Tilføj til eksisterende bookinger så availability virker live i samme session
            _existingBookings.Add(_created);

            // 2) Find / opret bruger
            int? effectiveUserId;

            if (SelectedUserId.HasValue)
            {
                // Eksisterende kunde valgt → genbrug Id,
                // så vi undgår duplikat-brugere og sparer tid
                effectiveUserId = SelectedUserId.Value;
            }
            else
            {
                // Ny kunde → generér automatisk stærkt random password
                var generatedPassword = GenerateRandomPassword(16);

                var userId = await AuthService.RegisterAsync(
                    generatedPassword,
                    _user.Name,
                    _user.Email,
                    _user.Address,
                    _user.Phone,
                    _user.Country,
                    _user.Language
                );

                if (!(userId is int id) || id <= 0)
                {
                    _error = "Bruger kunne ikke oprettes. Booking er oprettet, men ikke bekræftet.";
                    CurrentStep = 2;
                    await ScrollToSection("step-summary");
                    return;
                }

                effectiveUserId = id;
            }

            _userId = effectiveUserId.Value;

            // 3) Bekræft booking (BookingController sørger for email + PDF-kvittering)
            var success = await BookingService.ConfirmAsync(_created.Id, _userId);
            if (success)
            {
                _debugMessage = "Booking og bruger bekræftet, mail sendt.";
                CurrentStep = 3;
                await ScrollToSection("step-confirmation");
            }
            else
            {
                _error = "Booking kunne ikke bekræftes efter oprettelse.";
                CurrentStep = 2;
                await ScrollToSection("step-summary");
            }
        }
        catch (Exception ex)
        {
            // Generel fejl-håndtering (f.eks. netværk, database, mail-fejl)
            _error = $"Fejl ved bekræftelse: {ex.Message}";
        }
    }

    // Genererer et stærkt tilfældigt password.
    // Passwordet vises aldrig i UI – det er kun til fremtidsscenariet med login-funktionalitet.
    private static string GenerateRandomPassword(int length = 16)
    {
        // Genererer tilfældige bytes og konverterer til Base64-streng
        var bytes = RandomNumberGenerator.GetBytes(length);
        return Convert.ToBase64String(bytes);
    }

    // Skifter trin og scroller til det relevante kort i UI
    private void GoBackToStep(int step)
    {
        _error = "";
        CurrentStep = step;
        var id = step switch
        {
            0 => "step-booking",
            1 => "step-user",
            2 => "step-summary",
            _ => "step-booking"
        };
        _ = ScrollToSection(id);
    }

    // Simpel helper til at scrolle til et givent element ved id (bruges i wizard-flow)
    private async Task ScrollToSection(string id)
    {
        try
        {
            await JS.InvokeVoidAsync("eval", $"document.getElementById('{id}')?.scrollIntoView({{behavior:'smooth', block:'start'}})");
        }
        catch
        {
            // Ignorer JS fejl – skal ikke vælte hele siden
        }
    }

    // Nulstiller hele wizard-flowet, så admin kan oprette en helt ny booking
    private void StartNewBooking()
    {
        CurrentStep = 0;
        _dto = new BookingDto
        {
            StartDate = DateTime.Today,
            EndDate = DateTime.Today.AddDays(1),
            ProductId = 0,
            NumberOfPeople = 1,
            BookingAddons = new List<BookingAddonDto>()
        };

        _created = null;
        _hasAttemptedCreate = false;   // Sørger for at "Afvent venligst" beskeden forsvinder
        _error = "";                   // Ryd gamle fejlbeskeder
        _debugMessage = "";            // Ryd debug-tekst

        _selectedAddonIds.Clear();
        _addonQuantities.Clear();
        foreach (var addon in _addons) _addonQuantities[addon.Id] = 1;

        _user = new AuthRequest();
        _personError = "";
        _dateError = "";
        SelectedUserId = null;

        UpdateTotal();
        _ = ScrollToSection("step-booking");
    }


    // Kaldes når en addon checkbox toggles
    private void ToggleAddon(int addonId, ChangeEventArgs e)
    {
        bool isChecked = e.Value?.ToString()?.ToLower() == "true" || e.Value?.ToString() == "on";
        if (isChecked) _selectedAddonIds.Add(addonId);
        else _selectedAddonIds.Remove(addonId);
        UpdateTotal();
    }

    // Henter aktuelt quantity for given addon (default = 1)
    private int GetQuantity(int id) =>
        _addonQuantities.TryGetValue(id, out var q) ? Math.Max(q, 1) : 1;

    // Sætter quantity for given addon og recalculerer pris
    private void SetQuantity(int id, int q)
    {
        _addonQuantities[id] = Math.Max(q, 1);
        UpdateTotal();
    }

    // Oversætter enum til dansk tekst til visning i dropdown
    private static string TranslateType(ProductType type) => type switch
    {
        ProductType.Cottage => "Hytte",
        ProductType.GrassField => "Græsplads",
        _ => type.ToString()
    };
}
