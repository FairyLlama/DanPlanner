@page "/camping"
@rendermode InteractiveServer
@using Danplanner.Shared.Models
@using Danplanner.Client.Services
@using System.Text.Json
@using System.ComponentModel.DataAnnotations
@using System.Globalization
@inject ICampingSitesService CampingApi
@inject IJSRuntime JS

<h3>Her finder du vores Campingplads</h3>





<div id="map" style="height:500px; width:100%; border:1px solid #ccc;" class="mb-3"></div>


<!-- Kontaktsektion -->
<div class="row mt-5">
    <!-- Venstre kolonne -->
    <div class="col-md-6">
        <h4>Kontakt</h4>
        <p>
            <strong>Danplanner camping</strong><br />
            Udbyhøjvej 10<br />
            4180 Sorø<br />
            Danmark
        </p>

        <p>
            <strong>Telefon:</strong> <a href="tel:+4557830202">+45 57 83 02 02</a><br />
            <strong>Email:</strong> <a href="mailto:danplanner.dk">info@danplannercamping.dk</a>
        </p>

        <h5>Åbningstider</h5>
        <p>Vi har åbent <strong>HELE ÅRET, alle dage 24/7</strong>.</p>
    </div>

    <!-- Højre kolonne -->
    <div class="col-md-6">
        <h4 class="mb-3">Skriv til os</h4>
        <EditForm Model="@formModel" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="mb-2">
                <InputText class="form-control form-control-sm" @bind-Value="formModel.Name" placeholder="Navn" />
            </div>

            <div class="row mb-2">
                <div class="col">
                    <InputText class="form-control form-control-sm" @bind-Value="formModel.Email" placeholder="E-mail" />
                </div>
                <div class="col">
                    <InputText class="form-control form-control-sm" @bind-Value="formModel.Phone" placeholder="Telefon" />
                </div>
            </div>

            <div class="mb-2">
                <InputTextArea class="form-control form-control-sm" @bind-Value="formModel.Message" placeholder="Skriv en besked" rows="4" />
            </div>

            <div class="mb-2">
                <InputText class="form-control form-control-sm w-25" @bind-Value="formModel.Captcha" placeholder="Hvad er 2 + 2?" />
            </div>

            <div class="mb-2">
                <button type="submit" class="btn btn-success btn-sm w-100">Send</button>
            </div>
        </EditForm>

        @if (formSubmitted)
        {
            <div class="alert alert-success mt-2 py-1 px-2">
                ✅ Tak for din besked! Vi vender tilbage snarest.
            </div>
        }
    </div>
</div>


@code {
    private CampingSiteDto? site;

    protected override async Task OnInitializedAsync()
    {
        var address = "Udbyhøjvej 10, 4180 Sorø";
        var result = await GeocodeAsync(address);

        if (result.HasValue)
        {
            var (lat, lon) = result.Value;
            site = new CampingSiteDto
            {
                Name = "Danplanner Campingplads",
                Region = "Sjælland",
                Address = address,
                Latitude = lat,
                Longitude = lon
            };
            Console.WriteLine($"[Init] Geocode OK: {lat}, {lon}");
        }
        else
        {
            site = new CampingSiteDto
            {
                Name = "Sorø Camping (fallback)",
                Region = "Sjælland",
                Address = address,
                Latitude = 55.4467,
                Longitude = 11.5462
            };
            Console.WriteLine("[Init] Geocode TOM → bruger fallback coords");
        }

        // 🔹 Kald JS direkte her
        if (site != null)
        {
            try
            {
                await JS.InvokeVoidAsync("showCampingSite", new
                {
                    name = site.Name,
                    region = site.Region,
                    address = site.Address,
                    latitude = site.Latitude,
                    longitude = site.Longitude
                });
                Console.WriteLine("[Blazor] showCampingSite invoked direkte fra OnInitializedAsync");
            }
            catch (Exception ex)
            {
                Console.WriteLine("[Blazor] JS interop FAILED: " + ex.Message);
            }
        }
    }

    private async Task<(double lat, double lon)?> GeocodeAsync(string address)
    {
        using var client = new HttpClient { Timeout = TimeSpan.FromSeconds(10) };
        client.DefaultRequestHeaders.UserAgent.ParseAdd("DanPlannerExam/1.0");

        var url = $"https://nominatim.openstreetmap.org/search?format=json&q={Uri.EscapeDataString(address)}";

        string json;
        try
        {
            json = await client.GetStringAsync(url);
        }
        catch (Exception ex)
        {
            Console.WriteLine("[Geocode] Fejl: " + ex.Message);
            return null;
        }

        using var doc = JsonDocument.Parse(json);
        var arr = doc.RootElement;

        if (arr.ValueKind != JsonValueKind.Array || arr.GetArrayLength() == 0)
        {
            Console.WriteLine("[Geocode] Tomt resultat for: " + address);
            return null;
        }

        var first = arr[0];
        var latStr = first.GetProperty("lat").GetString();
        var lonStr = first.GetProperty("lon").GetString();

        if (!double.TryParse(latStr, NumberStyles.Float, CultureInfo.InvariantCulture, out var lat) ||
            !double.TryParse(lonStr, NumberStyles.Float, CultureInfo.InvariantCulture, out var lon))
        {
            Console.WriteLine($"[Geocode] Kunne ikke parse lat/lon: lat='{latStr}', lon='{lonStr}'");
            return null;
        }

        return (lat, lon);
    }


    private ContactFormModel formModel = new();
    private bool formSubmitted = false;

    private void HandleSubmit()
    {
        if (formModel.Captcha?.Trim() != "4")
        {
            Console.WriteLine("[Form] Forkert captcha-svar");
            return;
        }

        Console.WriteLine("[Form] Besked modtaget:");
        Console.WriteLine($"Navn: {formModel.Name}");
        Console.WriteLine($"Email: {formModel.Email}");
        Console.WriteLine($"Telefon: {formModel.Phone}");
        Console.WriteLine($"Besked: {formModel.Message}");

        formSubmitted = true;
        formModel = new(); // reset
    }

    public class ContactFormModel
    {
        [Required(ErrorMessage = "Navn er påkrævet")]
        public string? Name { get; set; }

        [Required(ErrorMessage = "Email er påkrævet")]
        [EmailAddress(ErrorMessage = "Ugyldig email")]
        public string? Email { get; set; }

        public string? Phone { get; set; }

        [Required(ErrorMessage = "Besked er påkrævet")]
        public string? Message { get; set; }

        [Required(ErrorMessage = "Svar på regnestykket er påkrævet")]
        public string? Captcha { get; set; }
    }

}