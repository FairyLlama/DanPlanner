version: "3.9"

services:
  usersdb:
    image: my-mysql-with-init
    environment:
      MYSQL_ROOT_PASSWORD: rootpw
      MYSQL_DATABASE: usersdb
    ports:
      - "3307:3306"
    volumes:
      - usersdb-data:/var/lib/mysql
    deploy:
      replicas: 1

  authenticationservice:
    image: authenticationservice:latest
    environment:
      ConnectionStrings__MySql: "Server=usersdb;Port=3306;Database=usersdb;User=root;Password=rootpw"
      Jwt__Key: "super_secret_exam_key_that_is_long_enough_123456"
      Jwt__Issuer: "AuthService"
      Jwt__Audience: "Gateway"   # <-- Ã¦ndret fra BlazorApp
      ASPNETCORE_URLS: "http://+:5000"
      DOTNET_ENVIRONMENT: "Docker"
    depends_on:
      - usersdb
    deploy:
      replicas: 2

  server:
    image: server:latest
    environment:
      ASPNETCORE_URLS: "http://+:5001"
      DOTNET_ENVIRONMENT: "Docker"
    depends_on:
      - authenticationservice
    deploy:
      replicas: 1

  gateway:
    image: gateway:latest
    environment:
      ASPNETCORE_URLS: "http://+:8080"
      DOTNET_ENVIRONMENT: "Docker"
    depends_on:
      - authenticationservice
      - server
    ports:
      - "8080:8080"

volumes:
  usersdb-data: